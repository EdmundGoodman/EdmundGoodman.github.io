<!doctype html><html lang=en-gb><head><meta name=author content="Edmund Goodman"><meta name=description content="The personal website for Edmund Goodman"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=/images/favicon.ico sizes=any type=image/x-icon><title>Fixing EndeavourOS Boot Failures | Edmund Goodman</title>
<link rel=stylesheet href=https://edmundgoodman.github.io/scss/main.c83abf7d8ed35d9b6a909f0d5a1a06a4d6e901c4b7640ee2683f59d2fb8f09be.css integrity="sha256-yDq/fY7TXZtqkJ8NWhoGpNbpAcS3ZA7iaD9Z0vuPCb4="></head><body><nav><ul class=nav-menu><li class="nav-item nav-home"><a href=/>Home</a></li><li class="nav-item nav-elided"><a href=/about>About</a></li><li class="nav-item nav-elided"><a href=/posts/>Blog</a></li><li class=nav-item><a href=/atlas/>Atlas</a></li></ul></nav><main><header><h1>Fixing EndeavourOS Boot Failures</h1><div class=post-meta><svg width="1.25em" height="1.25em" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom:-.3em"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 7a2 2 0 012-2h12a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V7z"/><path d="M16 3v4"/><path d="M8 3v4"/><path d="M4 11h16"/><path d="M7 14h.013"/><path d="M10.01 14h.005"/><path d="M13.01 14h.005"/><path d="M16.015 14h.005"/><path d="M13.015 17h.005"/><path d="M7.01 17h.005"/><path d="M10.01 17h.005"/></svg>
<time datetime=2024-01-13>Jan 13, 2024</time>
&nbsp;&bull;&nbsp;
<svg width="1.25em" height="1.25em" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom:-.3em"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 12a9 9 0 1018 0A9 9 0 003 12"/><path d="M12 7v5l3 3"/></svg>
4 minutes</div><br></header><article><p>This post enumerates a process which worked for me to repair an installation of EndeavourOS with full-disk encryption when it is unable to boot. It is also available <a href=https://gist.github.com/EdmundGoodman/c057ce0c826fd0edde7917d15b709f4f>as a gist</a>.</p><p>Specifically, this set of steps fixed the boot process on a HP-Envy laptop running EndeavourOS with an ext4 file system. The issue normally occurs after an interrupted update using <code>pacman -Syu</code>, which then causes the system to be unable to boot after the next restart (showing only &ldquo;boot to firmware interface&rdquo; in the boot menu).</p><h2 id=steps-to-fix>Steps to fix</h2><h3 id=1-boot-with-an-endeavouros-live-usb-stick>1) Boot with an EndeavourOS live USB stick</h3><p>You will need a live/bootable USB key with EndeavourOS installed on it. The <a href=https://discovery.endeavouros.com/installation/create-install-media-usb-key/2021/03/>EndeavourOS website lists a number of ways to do this</a>
<a href=#footnote--1><sup>[1]</sup></a>
.</p><p>Then, boot the computer from this live USB stick. This normally involves a process similar to:</p><ol><li>Turning off the computer</li><li>Plugging in the USB stick</li><li>Turning on computer, then repeatedly pressing the ESC key, until a boot menu shows up</li><li>Navigate to select the boot device in the boot menu, then select the option to boot from the live USB</li></ol><p>This should drop you into a working EndeavourOS operating system, from which you can run the steps to fix the broken one on the computer. All the next steps are commands to run in a terminal, which can be opened with <code>ctrl+alt+t</code>.</p><p>Additionally, you should connect to a WiFi network on the live boot, as this makes copy-pasting commands from the internet easier &#x1f605;, and allows downloading/completing updates to the broken boot device.</p><h3 id=2-decrypt-and-mount-the-encrypted-and-boot-disk-partitions>2) Decrypt and mount the encrypted and boot disk partitions</h3><p>First, identify your boot and encrypted partitions
<a href=#footnote--2><sup>[2]</sup></a>
:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>lsblk -f
</span></span></code></pre></div><p>This will list the available devices, from which you need to identify your boot and encrypted partitions. For my particular laptop:</p><ul><li>Encrypted partition = <code>nvme0n1p2</code></li><li>Boot partition = <code>nvme0n1p1</code></li></ul><p>Next, use <code>cryptsetup</code> to decrypt the LUKS encrypted drive
<a href=#footnote--3><sup>[3]</sup></a>
:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo cryptsetup open /dev/nvme0n1p2 luks_root
</span></span></code></pre></div><p>Then, mount the newly decrypted partition and then the boot drive into the <code>/boot/</code> folder within it
<a href=#footnote--4><sup>[4]</sup></a>
:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo mount /dev/mapper/luks_root /mnt
</span></span><span style=display:flex><span>sudo mount /dev/nvme0n1p1 /mnt/boot
</span></span></code></pre></div><h3 id=3-root-into-the-broken-system>3) Root into the broken system</h3><p><strong>Before this step, it is helpful to have connected to the WiFi on the live boot, as you would on any Linux computer</strong>
<a href=#footnote--5><sup>[5]</sup></a>
.</p><p>Next, use <code>arch-chroot</code> to root into the newly mounted broken system
<a href=#footnote--6><sup>[6]</sup></a>
:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo arch-chroot /mnt
</span></span></code></pre></div><h3 id=4-debugging-wifi-inside-arch-chroot>4) Debugging WiFi inside <code>arch-chroot</code></h3><p>You can check whether WiFi is working inside <code>arch-chroot</code> using the <code>ping</code> command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ping google.com
</span></span></code></pre></div><p>If the WiFi doesn&rsquo;t work inside <code>arch-chroot</code> on the broken device, first check if it is working on the live boot. If it isn&rsquo;t, fix it there, then exit and rerun <code>arch-chroot</code>.</p><p>If it still isn&rsquo;t working, the next most likely cause it DNS settings haven&rsquo;t been copied over. To fix this, exit the <code>arch-chroot</code> to unlock the <code>resolv.conf</code> file, add DNS settings, then rerun <code>arch-chroot</code>
<a href=#footnote--7><sup>[7]</sup></a>
:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>exit
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;nameserver 8.8.8.8&#34;</span> &gt;&gt; /mnt/etc/resolv.conf
</span></span><span style=display:flex><span>arch-chroot /mnt
</span></span></code></pre></div><h3 id=5-try-to-repair-the-broken-system>5) Try to repair the broken system</h3><p>The common issues I have found across two failures are as follows:</p><ul><li><code>pacman</code> was interrupted during running, so the lock file is still present
<a href=#footnote--8><sup>[8]</sup></a></li><li><code>pacman</code> needs to finish the interrupted upgrade</li><li>linux headers need to be re-installed</li><li><code>grub</code> needs to be re-built
<a href=#footnote--9><sup>[9]</sup></a></li></ul><p>These can be resolved as follows (inside <code>arch-chroot</code> on the broken device):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo rm /var/lib/pacman/db.lck
</span></span><span style=display:flex><span>sudo pacman -Syu
</span></span><span style=display:flex><span>sudo pacman -Syu linux-lts linux-lts-headers
</span></span><span style=display:flex><span>grub install --target<span style=color:#f92672>=</span>x86_54-efi --efi-directory<span style=color:#f92672>=</span>/boot/efi --bootloader-id<span style=color:#f92672>=</span>GRUB
</span></span><span style=display:flex><span>grub-mkconfig -o /boot/grub/grub.cfg
</span></span></code></pre></div><p>If <code>pacman</code> reports &lsquo;&ldquo;Failed to commit transaction (conflicting files)&rdquo; error&rsquo; whilst you re-attempt the update, a nuclear option is to reinstall all packages, overwriting existing installations in the file system
<a href=#footnote--10><sup>[10]</sup></a>
, with the following command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pacman -Syu <span style=color:#66d9ef>$(</span>pacman -Qnq<span style=color:#66d9ef>)</span> --overwrite <span style=color:#e6db74>&#34;*&#34;</span>
</span></span></code></pre></div><p>It is possible something else is wrong, but this time is when you should largely be running commands to fix it!</p><p>Then, disconnect from the <code>arch-chroot</code> as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>exit
</span></span></code></pre></div><h3 id=6-clean-up-and-try-to-boot>6) Clean up and try to boot</h3><p>Before restarting, it is good practice to unmount both the boot and decrypted partitions, then close the decrypted partition
<a href=#footnote--11><sup>[11]</sup></a>
.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo umount /mnt/boot/
</span></span><span style=display:flex><span>sudo umount /mnt
</span></span><span style=display:flex><span>sudo cryptsetup close luks_root
</span></span></code></pre></div><p>Finally, restart the computer, and hope that it boots correctly!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>reboot
</span></span></code></pre></div><h2 id=references>References</h2><ul><li><span id=footnote--1>[1]</span>: <a href=https://discovery.endeavouros.com/installation/create-install-media-usb-key/2021/03/)>https://discovery.endeavouros.com/installation/create-install-media-usb-key/2021/03/)</a></li><li><span id=footnote--10>[10]</span>: <a href=https://forum.endeavouros.com/t/multiple-issues-including-booting-problem-seemingly-broken-file-and-fatal-library-error/51906/3>https://forum.endeavouros.com/t/multiple-issues-including-booting-problem-seemingly-broken-file-and-fatal-library-error/51906/3</a></li><li><span id=footnote--11>[11]</span>: <a href=https://linux.fernandocejas.com/docs/guides/mount-luks-partition-for-system-recovery#4---unmount-and-exit>https://linux.fernandocejas.com/docs/guides/mount-luks-partition-for-system-recovery#4---unmount-and-exit</a></li><li><span id=footnote--2>[2]</span>: <a href=https://linux.fernandocejas.com/docs/guides/mount-luks-partition-for-system-recovery#mount-luks-partitions-for-system-recovery>https://linux.fernandocejas.com/docs/guides/mount-luks-partition-for-system-recovery#mount-luks-partitions-for-system-recovery</a></li><li><span id=footnote--3>[3]</span>: <a href=https://linux.fernandocejas.com/docs/guides/mount-luks-partition-for-system-recovery#1---open-the-encrypted-disk>https://linux.fernandocejas.com/docs/guides/mount-luks-partition-for-system-recovery#1---open-the-encrypted-disk</a></li><li><span id=footnote--4>[4]</span>: <a href=https://linux.fernandocejas.com/docs/guides/mount-luks-partition-for-system-recovery#2---mount-all-the-partitions>https://linux.fernandocejas.com/docs/guides/mount-luks-partition-for-system-recovery#2---mount-all-the-partitions</a></li><li><span id=footnote--5>[5]</span>: It doesn&rsquo;t break anything if you don&rsquo;t connect to WiFi. However, if you later need WiFi access on the broken boot device you&rsquo;ll need to exit out, connect to WiFi, and <code>arch-chroot</code> back in if you haven&rsquo;t.</li><li><span id=footnote--6>[6]</span>: <a href=https://linux.fernandocejas.com/docs/guides/mount-luks-partition-for-system-recovery#3---root-into-the-new-system>https://linux.fernandocejas.com/docs/guides/mount-luks-partition-for-system-recovery#3---root-into-the-new-system</a></li><li><span id=footnote--7>[7]</span>: <a href=https://unix.stackexchange.com/a/481862>https://unix.stackexchange.com/a/481862</a></li><li><span id=footnote--8>[8]</span>: <a href=https://forum.endeavouros.com/t/update-problem-var-lib-pacman-db-lck/5239/2>https://forum.endeavouros.com/t/update-problem-var-lib-pacman-db-lck/5239/2</a></li><li><span id=footnote--9>[9]</span>: <a href=https://wiki.archlinux.org/title/GRUB>https://wiki.archlinux.org/title/GRUB</a></li></ul></article></main><footer><p>© 2024 Edmund Goodman | 
<a href=https://github.com/EdmundGoodman/edmundgoodman.github.io>Source</a> | 
<a href=https://creativecommons.org/licenses/by-nc/4.0/>License</a></p><footer></body></html>